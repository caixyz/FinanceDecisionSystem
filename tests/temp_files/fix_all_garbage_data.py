#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä¿®å¤æ‰€æœ‰åƒåœ¾æ•°æ® - å°†å¸‚åœºæ¿å—æ•°æ®æ›¿æ¢ä¸ºçœŸå®è¡Œä¸šåˆ†ç±»
åŸºäºè‚¡ç¥¨åç§°æ™ºèƒ½è¯†åˆ«è¡Œä¸šåˆ†ç±»
"""
import sqlite3
import pandas as pd
import re
from typing import Dict, List, Tuple

class IndustryFixer:
    """è¡Œä¸šæ•°æ®ä¿®å¤å™¨"""
    
    def __init__(self):
        self.conn = sqlite3.connect('data/finance_data.db')
        self.cursor = self.conn.cursor()
        
        # è¡Œä¸šå…³é”®è¯æ˜ å°„
        self.industry_keywords = {
            'é“¶è¡Œ': ['é“¶è¡Œ', 'å•†è¡Œ', 'å‚¨è“„'],
            'è¯åˆ¸': ['è¯åˆ¸', 'åˆ¸å•†', 'è¯åˆ¸è‚¡ä»½'],
            'ä¿é™©': ['ä¿é™©', 'äººå¯¿', 'è´¢äº§é™©', 'å¥åº·é™©'],
            'é…¿é…’è¡Œä¸š': ['èŒ…å°', 'äº”ç²®æ¶²', 'æ³¸å·è€çª–', 'æ±¾é…’', 'å¤äº•è´¡', 'æ´‹æ²³', 'å•¤é…’', 'ç™½é…’', 'é»„é…’', 'è‘¡è„é…’', 'é…’é¬¼é…’'],
            'é£Ÿå“é¥®æ–™': ['é£Ÿå“', 'é¥®æ–™', 'ä¹³å“', 'ä¹³ä¸š', 'è°ƒå‘³å“', 'è‚‰åˆ¶å“', 'é£Ÿç”¨æ²¹'],
            'åŒ»è¯åˆ¶é€ ': ['åŒ»è¯', 'åˆ¶è¯', 'è¯ä¸š', 'ç”Ÿç‰©', 'åŒ»ç–—', 'å¥åº·', 'ç–«è‹—', 'ä¸­è¯', 'è¥¿è¯'],
            'å®¶ç”µè¡Œä¸š': ['å®¶ç”µ', 'ç”µå™¨', 'ç©ºè°ƒ', 'å†°ç®±', 'æ´—è¡£æœº', 'ç¾çš„', 'æ ¼åŠ›', 'æµ·å°”', 'TCL'],
            'æˆ¿åœ°äº§': ['åœ°äº§', 'æˆ¿åœ°äº§', 'ç½®ä¸š', 'ç‰©ä¸š', 'å»ºè®¾', 'åŸå»º', 'æˆ¿äº§'],
            'æ±½è½¦æ•´è½¦': ['æ±½è½¦', 'è½¿è½¦', 'å®¢è½¦', 'è´§è½¦', 'æ–°èƒ½æº', 'æ¯”äºšè¿ª', 'é•¿åŸ', 'å‰åˆ©', 'é•¿å®‰'],
            'ç”µåŠ›è¡Œä¸š': ['ç”µåŠ›', 'ç”µç½‘', 'å‘ç”µ', 'ä¾›ç”µ', 'èƒ½æº', 'æ°´ç”µ', 'ç«ç”µ', 'æ ¸ç”µ'],
            'é’¢é“': ['é’¢é“', 'é’¢', 'é“', 'å†¶é‡‘', 'ä¸é”ˆé’¢', 'å®é’¢', 'éé’¢', 'é¦–é’¢'],
            'æœ‰è‰²é‡‘å±': ['æœ‰è‰²', 'é“œ', 'é“', 'é“…', 'é”Œ', 'é»„é‡‘', 'ç¨€åœŸ', 'é”‚', 'é’´', 'é•'],
            'ç…¤ç‚­': ['ç…¤ç‚­', 'ç…¤çŸ¿', 'èƒ½æº', 'ç…¤ä¸š', 'ç„¦ç…¤', 'åŠ¨åŠ›ç…¤'],
            'çŸ³æ²¹': ['çŸ³æ²¹', 'çŸ³åŒ–', 'å¤©ç„¶æ°”', 'æ²¹æ°”', 'ä¸­çŸ³æ²¹', 'ä¸­çŸ³åŒ–', 'ä¸­æµ·æ²¹'],
            'åŒ–å·¥': ['åŒ–å·¥', 'åŒ–å­¦', 'åŒ–è‚¥', 'å†œè¯', 'å¡‘æ–™', 'æ©¡èƒ¶', 'åŒ–çº¤', 'æŸ“æ–™'],
            'æœºæ¢°': ['æœºæ¢°', 'æœºåºŠ', 'è®¾å¤‡', 'é‡å·¥', 'å·¥ç¨‹æœºæ¢°', 'è£…å¤‡åˆ¶é€ '],
            'ç”µå­': ['ç”µå­', 'åŠå¯¼ä½“', 'èŠ¯ç‰‡', 'é›†æˆç”µè·¯', 'ç”µå­å…ƒä»¶', 'æ¶ˆè´¹ç”µå­'],
            'é€šä¿¡': ['é€šä¿¡', 'ç”µä¿¡', 'ç§»åŠ¨', 'è”é€š', 'ç”µä¿¡', '5G', 'é€šä¿¡è®¾å¤‡'],
            'è®¡ç®—æœº': ['è®¡ç®—æœº', 'è½¯ä»¶', 'ä¿¡æ¯', 'ç§‘æŠ€', 'äº’è”ç½‘', 'äº‘è®¡ç®—', 'å¤§æ•°æ®', 'äººå·¥æ™ºèƒ½'],
            'ä¼ åª’': ['ä¼ åª’', 'æ–‡åŒ–', 'å½±è§†', 'å‡ºç‰ˆ', 'å¹¿å‘Š', 'æ¸¸æˆ', 'åŠ¨æ¼«', 'æ–°åª’ä½“'],
            'äº¤é€šè¿è¾“': ['äº¤é€š', 'è¿è¾“', 'ç‰©æµ', 'èˆªè¿', 'æ¸¯å£', 'æœºåœº', 'é“è·¯', 'å…¬è·¯', 'å¿«é€’'],
            'é›¶å”®': ['é›¶å”®', 'è¶…å¸‚', 'ç™¾è´§', 'å•†ä¸š', 'è¿é”', 'ç”µå•†', 'ç½‘è´­'],
            'å»ºæ': ['å»ºæ', 'æ°´æ³¥', 'ç»ç’ƒ', 'é™¶ç“·', 'çŸ³æ', 'è£…é¥°ææ–™'],
            'å†œä¸š': ['å†œä¸š', 'å†œ', 'ç‰§', 'æ¸”', 'æ—', 'ç§ä¸š', 'åŒ–è‚¥', 'å†œè¯', 'é¥²æ–™'],
            'ç¯ä¿': ['ç¯ä¿', 'ç¯å¢ƒ', 'æ°´å¤„ç†', 'å›ºåºŸ', 'å¤§æ°”æ²»ç†', 'æ¸…æ´èƒ½æº'],
            'å†›å·¥': ['å†›å·¥', 'å›½é˜²', 'èˆªå¤©', 'èˆªç©º', 'èˆ¹èˆ¶', 'å…µå™¨', 'å†›å·¥ç”µå­'],
            'æ•™è‚²': ['æ•™è‚²', 'å­¦æ ¡', 'åŸ¹è®­', 'åœ¨çº¿æ•™è‚²', 'èŒä¸šæ•™è‚²'],
            'æ—…æ¸¸': ['æ—…æ¸¸', 'é…’åº—', 'æ™¯åŒº', 'æ—…è¡Œç¤¾', 'é¤é¥®', 'åº¦å‡æ‘'],
            'ç å®é¦–é¥°': ['ç å®', 'é¦–é¥°', 'é»„é‡‘', 'é’»çŸ³', 'é¥°å“', 'èœç™¾'],
            'çººç»‡æœè£…': ['æœè£…', 'çººç»‡', 'æœé¥°', 'é‹å¸½', 'å®¶çºº', 'é¢æ–™'],
            'é€ çº¸': ['é€ çº¸', 'çº¸ä¸š', 'çº¸æµ†', 'åŒ…è£…', 'å°åˆ·'],
            'å»ºç­‘': ['å»ºç­‘', 'å·¥ç¨‹', 'æ–½å·¥', 'åŸºå»º', 'å»ºç­‘å®‰è£…'],
        }
    
    def get_industry_by_name(self, stock_name: str, symbol: str) -> str:
        """æ ¹æ®è‚¡ç¥¨åç§°å’Œä»£ç æ™ºèƒ½è¯†åˆ«è¡Œä¸š"""
        stock_name = str(stock_name).upper()
        symbol = str(symbol)
        
        # ç‰¹æ®Šè‚¡ç¥¨æ˜ å°„
        special_mapping = {
            '601398': 'é“¶è¡Œ',
            '600036': 'é“¶è¡Œ',
            '000001': 'é“¶è¡Œ',
            '601288': 'é“¶è¡Œ',
            '601939': 'é“¶è¡Œ',
            '601988': 'é“¶è¡Œ',
            '600519': 'é…¿é…’è¡Œä¸š',
            '000858': 'é…¿é…’è¡Œä¸š',
            '000568': 'é…¿é…’è¡Œä¸š',
            '000799': 'é…¿é…’è¡Œä¸š',
            '600030': 'è¯åˆ¸',
            '601688': 'è¯åˆ¸',
            '000776': 'è¯åˆ¸',
            '601211': 'è¯åˆ¸',
            '601318': 'ä¿é™©',
            '601628': 'ä¿é™©',
            '601336': 'ä¿é™©',
            '605599': 'ç å®é¦–é¥°',
            '000002': 'æˆ¿åœ°äº§',
            '000333': 'å®¶ç”µè¡Œä¸š',
            '000651': 'å®¶ç”µè¡Œä¸š',
            '000725': 'ç”µå­',
            '000063': 'é€šä¿¡',
            '000100': 'å®¶ç”µè¡Œä¸š',
            '000423': 'åŒ»è¯åˆ¶é€ ',
            '000538': 'åŒ»è¯åˆ¶é€ ',
            '000596': 'é…¿é…’è¡Œä¸š',
            '000617': 'è¯åˆ¸',
            '000623': 'åŒ»è¯åˆ¶é€ ',
            '000625': 'æ±½è½¦æ•´è½¦',
            '000629': 'æœ‰è‰²é‡‘å±',
            '000630': 'æœ‰è‰²é‡‘å±',
            '000651': 'å®¶ç”µè¡Œä¸š',
            '000656': 'æˆ¿åœ°äº§',
            '000671': 'æˆ¿åœ°äº§',
            '000686': 'è¯åˆ¸',
            '000690': 'ç”µåŠ›è¡Œä¸š',
            '000708': 'é’¢é“',
            '000709': 'é’¢é“',
            '000712': 'è¯åˆ¸',
            '000713': 'å†œä¸š',
            '000716': 'é£Ÿå“é¥®æ–™',
            '000718': 'æˆ¿åœ°äº§',
            '000720': 'ç”µåŠ›è¡Œä¸š',
            '000725': 'ç”µå­',
            '000728': 'è¯åˆ¸',
            '000729': 'é…¿é…’è¡Œä¸š',
            '000732': 'æˆ¿åœ°äº§',
            '000735': 'å†œä¸š',
            '000738': 'å†›å·¥',
            '000750': 'è¯åˆ¸',
            '000751': 'æœ‰è‰²é‡‘å±',
            '000768': 'å†›å·¥',
            '000776': 'è¯åˆ¸',
            '000778': 'é’¢é“',
            '000783': 'è¯åˆ¸',
            '000786': 'å»ºæ',
            '000792': 'åŒ–å·¥',
            '000793': 'ä¼ åª’',
            '000800': 'æ±½è½¦æ•´è½¦',
            '000807': 'æœ‰è‰²é‡‘å±',
            '000816': 'æœºæ¢°',
            '000825': 'é’¢é“',
            '000826': 'ç¯ä¿',
            '000830': 'åŒ–å·¥',
            '000831': 'æœ‰è‰²é‡‘å±',
            '000839': 'ä¼ åª’',
            '000858': 'é…¿é…’è¡Œä¸š',
            '000860': 'é£Ÿå“é¥®æ–™',
            '000869': 'é…¿é…’è¡Œä¸š',
            '000876': 'å†œä¸š',
            '000877': 'å»ºæ',
            '000878': 'æœ‰è‰²é‡‘å±',
            '000883': 'ç”µåŠ›è¡Œä¸š',
            '000887': 'æ±½è½¦æ•´è½¦',
            '000895': 'é£Ÿå“é¥®æ–™',
            '000897': 'æˆ¿åœ°äº§',
            '000898': 'é’¢é“',
            '000900': 'äº¤é€šè¿è¾“',
            '000901': 'æœºæ¢°',
            '000917': 'ä¼ åª’',
            '000918': 'æˆ¿åœ°äº§',
            '000919': 'åŒ»è¯åˆ¶é€ ',
            '000921': 'å®¶ç”µè¡Œä¸š',
            '000922': 'ç”µåŠ›è¡Œä¸š',
            '000923': 'æœºæ¢°',
            '000925': 'äº¤é€šè¿è¾“',
            '000926': 'æˆ¿åœ°äº§',
            '000927': 'æ±½è½¦æ•´è½¦',
            '000928': 'æœ‰è‰²é‡‘å±',
            '000930': 'å†œä¸š',
            '000933': 'ç…¤ç‚­',
            '000937': 'ç…¤ç‚­',
            '000938': 'è®¡ç®—æœº',
            '000939': 'ç”µåŠ›è¡Œä¸š',
            '000948': 'åŒ»è¯åˆ¶é€ ',
            '000949': 'åŒ–å·¥',
            '000950': 'åŒ»è¯åˆ¶é€ ',
            '000951': 'æ±½è½¦æ•´è½¦',
            '000952': 'åŒ»è¯åˆ¶é€ ',
            '000953': 'åŒ–å·¥',
            '000955': 'æ±½è½¦æ•´è½¦',
            '000957': 'æ±½è½¦æ•´è½¦',
            '000958': 'ç”µåŠ›è¡Œä¸š',
            '000959': 'é’¢é“',
            '000960': 'æœ‰è‰²é‡‘å±',
            '000961': 'æˆ¿åœ°äº§',
            '000962': 'æœ‰è‰²é‡‘å±',
            '000963': 'åŒ»è¯åˆ¶é€ ',
            '000965': 'æˆ¿åœ°äº§',
            '000966': 'ç”µåŠ›è¡Œä¸š',
            '000967': 'ç¯ä¿',
            '000968': 'ç…¤ç‚­',
            '000969': 'æœ‰è‰²é‡‘å±',
            '000970': 'æœ‰è‰²é‡‘å±',
            '000975': 'æœ‰è‰²é‡‘å±',
            '000977': 'è®¡ç®—æœº',
            '000978': 'æ—…æ¸¸',
            '000979': 'æˆ¿åœ°äº§',
            '000980': 'æ±½è½¦æ•´è½¦',
            '000981': 'æˆ¿åœ°äº§',
            '000982': 'çººç»‡æœè£…',
            '000983': 'ç…¤ç‚­',
            '000985': 'ç…¤ç‚­',
            '000987': 'è¯åˆ¸',
            '000988': 'è®¡ç®—æœº',
            '000989': 'åŒ»è¯åˆ¶é€ ',
            '000990': 'åŒ–å·¥',
            '000993': 'ç”µåŠ›è¡Œä¸š',
            '000995': 'ä¼ åª’',
            '000996': 'è¯åˆ¸',
            '000997': 'è®¡ç®—æœº',
            '000998': 'å†œä¸š',
            '000999': 'åŒ»è¯åˆ¶é€ ',
        }
        
        # ç‰¹æ®Šè‚¡ç¥¨ä»£ç æ˜ å°„
        if symbol in special_mapping:
            return special_mapping[symbol]
        
        # å…³é”®è¯åŒ¹é…
        for industry, keywords in self.industry_keywords.items():
            for keyword in keywords:
                if keyword.upper() in stock_name:
                    return industry
        
        # é»˜è®¤è¿”å›å…¶ä»–
        return 'å…¶ä»–'
    
    def get_market_board_stocks(self) -> List[Tuple]:
        """è·å–æ‰€æœ‰å¸‚åœºæ¿å—æ•°æ®çš„è‚¡ç¥¨"""
        self.cursor.execute('''
            SELECT symbol, name, industry
            FROM stock_info
            WHERE industry IN ('ä¸Šè¯ä¸»æ¿', 'æ·±è¯ä¸»æ¿', 'åˆ›ä¸šæ¿', 'ç§‘åˆ›æ¿', 'åŒ—äº¤æ‰€')
            ORDER BY symbol
        ''')
        return self.cursor.fetchall()
    
    def fix_single_stock(self, symbol: str, name: str, current_industry: str) -> str:
        """ä¿®å¤å•åªè‚¡ç¥¨çš„è¡Œä¸šåˆ†ç±»"""
        new_industry = self.get_industry_by_name(name, symbol)
        
        if new_industry != current_industry:
            self.cursor.execute('''
                UPDATE stock_info 
                SET industry = ?, updated_at = datetime('now')
                WHERE symbol = ?
            ''', (new_industry, symbol))
            
        return new_industry
    
    def fix_all_garbage_data(self):
        """ä¿®å¤æ‰€æœ‰åƒåœ¾æ•°æ®"""
        print("ğŸš€ å¼€å§‹ä¿®å¤æ‰€æœ‰åƒåœ¾æ•°æ®...")
        print("=" * 60)
        
        # 1. è·å–éœ€è¦ä¿®å¤çš„è‚¡ç¥¨
        market_board_stocks = self.get_market_board_stocks()
        total_count = len(market_board_stocks)
        
        print(f"ğŸ“Š å‘ç° {total_count} åªè‚¡ç¥¨éœ€è¦ä¿®å¤")
        
        if total_count == 0:
            print("âœ… æ²¡æœ‰éœ€è¦ä¿®å¤çš„åƒåœ¾æ•°æ®")
            return
        
        # 2. åˆ†æ‰¹ä¿®å¤
        fixed_count = 0
        batch_size = 100
        
        for i, (symbol, name, current_industry) in enumerate(market_board_stocks):
            try:
                new_industry = self.fix_single_stock(symbol, name, current_industry)
                fixed_count += 1
                
                if i % batch_size == 0:
                    self.conn.commit()
                    print(f"ğŸ”„ å·²ä¿®å¤ {fixed_count}/{total_count} åªè‚¡ç¥¨")
                
            except Exception as e:
                print(f"âŒ ä¿®å¤ {symbol} å¤±è´¥: {e}")
        
        # 3. æäº¤æœ€ç»ˆæ›´æ”¹
        self.conn.commit()
        
        # 4. æ˜¾ç¤ºä¿®å¤ç»“æœç»Ÿè®¡
        self.show_fix_statistics()
        
        print(f"ğŸ‰ æ•°æ®ä¿®å¤å®Œæˆï¼å…±ä¿®å¤ {fixed_count} åªè‚¡ç¥¨")
    
    def show_fix_statistics(self):
        """æ˜¾ç¤ºä¿®å¤åçš„ç»Ÿè®¡ä¿¡æ¯"""
        print("\nğŸ“ˆ ä¿®å¤åçš„è¡Œä¸šåˆ†å¸ƒ:")
        print("-" * 40)
        
        self.cursor.execute('''
            SELECT industry, COUNT(*) as count
            FROM stock_info
            WHERE industry NOT IN ('ä¸Šè¯ä¸»æ¿', 'æ·±è¯ä¸»æ¿', 'åˆ›ä¸šæ¿', 'ç§‘åˆ›æ¿', 'åŒ—äº¤æ‰€')
            AND industry IS NOT NULL AND industry != ''
            GROUP BY industry
            ORDER BY count DESC
            LIMIT 20
        ''')
        
        results = self.cursor.fetchall()
        for industry, count in results:
            print(f"  {industry}: {count}åªè‚¡ç¥¨")
        
        # ç»Ÿè®¡å‰©ä½™åƒåœ¾æ•°æ®
        self.cursor.execute('''
            SELECT industry, COUNT(*) as count
            FROM stock_info
            WHERE industry IN ('ä¸Šè¯ä¸»æ¿', 'æ·±è¯ä¸»æ¿', 'åˆ›ä¸šæ¿', 'ç§‘åˆ›æ¿', 'åŒ—äº¤æ‰€')
            GROUP BY industry
            ORDER BY count DESC
        ''')
        
        remaining = self.cursor.fetchall()
        if remaining:
            print("\nâš ï¸ å‰©ä½™æœªä¿®å¤çš„åƒåœ¾æ•°æ®:")
            for industry, count in remaining:
                print(f"  {industry}: {count}åªè‚¡ç¥¨")
        else:
            print("\nâœ… æ‰€æœ‰åƒåœ¾æ•°æ®å·²ä¿®å¤å®Œæˆï¼")
    
    def close(self):
        """å…³é—­æ•°æ®åº“è¿æ¥"""
        self.conn.close()

def main():
    """ä¸»å‡½æ•°"""
    fixer = IndustryFixer()
    try:
        fixer.fix_all_garbage_data()
    finally:
        fixer.close()

if __name__ == "__main__":
    main()