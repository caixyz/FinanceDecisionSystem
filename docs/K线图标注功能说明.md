# K线图高低点标注功能说明

## 🎯 功能概述

K线图高低点标注功能已经成功实现！现在您可以在K线图上标注重要的高点和低点，帮助更好地分析股票价格走势。

## ✨ 标注模式

### 1. 全局最高低点标注 (global)
- **标注内容**: 整个时间段内的绝对最高点和最低点
- **颜色标识**: 
  - 🔴 红色框：全局最高点
  - 🟢 绿色框：全局最低点
- **适用场景**: 长期趋势分析、重要支撑阻力位识别

### 2. 局部最高低点标注 (local)
- **标注内容**: 多个局部转折点（通过算法识别）
- **颜色标识**:
  - 🟠 橙色框：局部高点
  - 🔵 青色框：局部低点
- **适用场景**: 短线交易、波段操作参考

### 3. 不标注模式 (none)
- **标注内容**: 不显示任何标注
- **适用场景**: 保持图表简洁，专注价格走势

## 🖥️ 使用方法

1. **打开Web界面**: 点击预览按钮访问系统界面
2. **输入股票代码**: 例如 `000858` (五粮液)
3. **选择分析天数**: 30天、60天、90天等
4. **选择高低点标注**: 在新增的下拉菜单中选择标注模式
5. **点击分析按钮**: 进行股票技术分析
6. **生成图表**: 点击"生成图表"按钮，查看带标注的K线图

## 🔧 技术实现

### 后端增强
- ✅ `visualization.py` 中实现了 `_mark_global_extremes()` 和 `_mark_local_extremes()` 方法
- ✅ API支持 `mark_extremes` 参数控制标注行为
- ✅ 使用scipy.signal.argrelextrema算法识别局部极值点
- ✅ 线程安全的matplotlib绘图，解决多线程问题

### 前端更新
- ✅ 添加"高低点标注"选择控件
- ✅ 图表生成函数支持传递标注参数
- ✅ 用户可动态切换不同标注模式

## 📊 算法特点

### 全局极值算法
```python
# 找到整个数据集的最高和最低点
high_idx = df['high'].idxmax()
low_idx = df['low'].idxmin()
```

### 局部极值算法
```python
# 使用scipy信号处理算法识别局部极值
from scipy.signal import argrelextrema
high_peaks = argrelextrema(highs, np.greater, order=window)[0]
low_peaks = argrelextrema(lows, np.less, order=window)[0]
```

## 🎨 视觉效果

- **智能标注**: 根据价格范围自动调整标注位置
- **清晰标识**: 使用不同颜色和形状区分标注类型
- **价格显示**: 标注中包含具体的价格数值
- **美观布局**: 标注不会遮挡重要的K线信息

## 💡 使用建议

1. **长期投资者**: 使用全局标注识别重要的买入和卖出时机
2. **短线交易者**: 使用局部标注捕捉波段操作机会
3. **技术分析**: 结合移动平均线等其他指标综合判断
4. **风险控制**: 将标注点作为止损和止盈的参考位置

## 🚀 测试案例

推荐测试股票：
- `000858` - 五粮液：波动较大，标注效果明显
- `000001` - 平安银行：走势相对稳定
- `600519` - 贵州茅台：长期上涨趋势

## 🔗 相关文件

- `core/visualization.py` - 核心绘图功能
- `app_safe.py` - 线程安全版Web服务
- `templates/index.html` - 前端界面
- `test_kline_extremes.py` - 功能测试脚本

---

**🎉 恭喜！K线图高低点标注功能已经完全实现并可以使用了！**