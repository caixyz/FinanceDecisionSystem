<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金融决策系统 - 调试版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            background-color: #f8f9fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .header p {
            text-align: center;
            opacity: 0.9;
        }

        .main-content {
            padding: 2rem 0;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.loading {
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.8s linear infinite;
        }

        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }

        .result-container {
            margin-top: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .success {
            color: #155724;
            background-color: #d4edda;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .metric {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            text-align: center;
        }

        /* 进度条样式 */
        .progress-container {
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .sync-status {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
        }

        /* 中央提示样式 */
        .notification-center {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }

        .sync-status h4 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .sync-status p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🏦 金融决策系统</h1>
            <p>基于 AKShare 的智能股票分析平台</p>
        </div>
    </div>

    <div class="container main-content">
        <!-- 股票分析 -->
        <div class="card">
            <h2>📈 股票技术分析</h2>
            <div class="form-group">
                <label for="stockSymbol">股票代码:</label>
                <input type="text" id="stockSymbol" placeholder="例如: 000001" />
            </div>
            <div class="form-group">
                <label for="analysisDays">分析天数:</label>
                <select id="analysisDays">
                    <option value="30">30天</option>
                    <option value="60">60天</option>
                    <option value="90" selected>90天</option>
                    <option value="180">180天</option>
                    <option value="252">一年</option>
                </select>
            </div>
            <button class="btn" onclick="analyzeStock()">开始分析</button>
            <div id="analysisResult" class="result-container"></div>
        </div>

        <!-- 策略回测 -->
        <div class="card">
            <h2>🔄 策略回测</h2>
            <div class="form-group">
                <label for="backtestSymbol">股票代码:</label>
                <input type="text" id="backtestSymbol" placeholder="例如: 000001" />
            </div>
            <div class="form-group">
                <label for="strategy">交易策略:</label>
                <select id="strategy">
                    <option value="MA策略">MA策略</option>
                    <option value="RSI策略">RSI策略</option>
                    <option value="MACD策略">MACD策略</option>
                    <option value="布林带策略">布林带策略</option>
                    <option value="综合策略">综合策略</option>
                </select>
            </div>
            <button class="btn" onclick="runBacktest()">开始回测</button>
            <div id="backtestResult" class="result-container"></div>
        </div>

        <!-- 生成报告 -->
        <div class="card">
            <h2>📊 生成分析报告</h2>
            <div class="form-group">
                <label for="reportSymbol">股票代码:</label>
                <input type="text" id="reportSymbol" placeholder="例如: 000001" />
            </div>
            <button class="btn" onclick="generateReport()">生成报告</button>
            <div id="reportResult" class="result-container"></div>
        </div>

        <!-- 股票数据管理 -->
        <div class="card" id="stockManagementCard">
            <h2>💾 股票数据管理</h2>
            <div class="form-group">
                <label for="searchKeyword">搜索股票:</label>
                <input type="text" id="searchKeyword" placeholder="输入股票代码或名称" />
                <button class="btn" onclick="searchStocks()" style="margin-top: 10px;">搜索</button>
            </div>
            <div id="searchResult" class="result-container"></div>
            
            <div style="margin-top: 2rem;">
                <h3>数据同步</h3>
                <button class="btn" onclick="syncStockList()" style="margin-right: 10px;">🔄 同步股票列表</button>
                <button class="btn" onclick="syncStockHistory()" style="margin-right: 10px;">📚 同步历史数据</button>
                <button class="btn" onclick="syncStockLatest()">⚡ 同步最新数据</button>
            </div>
            <div id="syncResult" class="result-container"></div>
        </div>
        
        <!-- 调试信息 -->
        <div class="card">
            <h2>🔧 调试信息</h2>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        // 页面加载完成后显示调试信息
        document.addEventListener('DOMContentLoaded', function() {
            // 检查股票数据管理卡片是否存在
            const stockManagementCard = document.getElementById('stockManagementCard');
            const debugInfo = document.getElementById('debugInfo');
            
            if (stockManagementCard) {
                debugInfo.innerHTML = '<div style="color: green;">✅ 股票数据管理区域已找到</div>';
            } else {
                debugInfo.innerHTML = '<div style="color: red;">❌ 未找到股票数据管理区域</div>';
            }
            
            // 显示页面上所有卡片的数量
            const cards = document.querySelectorAll('.card');
            debugInfo.innerHTML += `<div>📊 页面上共有 ${cards.length} 个功能卡片</div>`;
            
            // 列出所有卡片的标题
            cards.forEach((card, index) => {
                const title = card.querySelector('h2');
                if (title) {
                    debugInfo.innerHTML += `<div>📋 卡片 ${index + 1}: ${title.textContent}</div>`;
                }
            });
        });

        // API 基础URL
        const API_BASE = '/api';

        // 工具函数
        function showLoading(containerId) {
            document.getElementById(containerId).innerHTML = '<div class="loading">⏳ 处理中...</div>';
        }

        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="error">❌ ${message}</div>`;
        }

        function showSuccess(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="success">✅ ${message}</div>`;
        }

        // 股票搜索功能
        async function searchStocks() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            
            if (!keyword) {
                showError('searchResult', '请输入搜索关键词');
                return;
            }
            
            showLoading('searchResult');
            
            try {
                // 先获取完整的搜索结果总数
                const countResponse = await fetch(`${API_BASE}/stocks/list?keyword=${encodeURIComponent(keyword)}&limit=10000`);
                const countResult = await countResponse.json();
                
                if (countResult.code === 200) {
                    // 存储完整的搜索结果用于显示总数
                    window.searchResults = {
                        stocks: countResult.data.stocks,
                        total_count: countResult.data.stocks.length
                    };
                    displaySearchResults(countResult.data.stocks.slice(0, 20)); // 只显示前20条
                } else {
                    showError('searchResult', countResult.message);
                }
            } catch (error) {
                showError('searchResult', `搜索失败: ${error.message}`);
            }
        }
        
        function displaySearchResults(stocks) {
            const container = document.getElementById('searchResult');

            if (stocks.length === 0) {
                container.innerHTML = '<div class="error">未找到匹配的股票</div>';
                return;
            }

            // 获取完整的搜索结果总数（不仅仅是当前页）
            let totalCount = stocks.length;
            if (window.searchResults && window.searchResults.total_count) {
                totalCount = window.searchResults.total_count;
            }
            
            let html = '<h3 style="margin-bottom: 1rem;">搜索结果</h3>' +
                '<div class="grid">';
            stocks.forEach(stock => {
                html += `
                    <div class="metric" style="text-align: left;">
                        <div style="font-weight: bold; font-size: 1.2rem;">${stock.symbol}</div>
                        <div style="font-size: 1rem; margin: 5px 0;">${stock.name}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            // 添加结果总数
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem; background-color: #f8f9fa; border-radius: 8px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                        结果总数: ${totalCount}
                    </div>
                    <div style="color: #666; font-size: 0.9rem;">
                        显示 ${stocks.length} 条记录
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // 数据同步功能 - 带反重复点击和进度条
        let syncInProgress = false;
        let currentSyncType = null;

        // 进度条工具函数
        function showProgress(containerId, current, total, message = '') {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            const container = document.getElementById(containerId);
            
            let html = `
                <div class="sync-status">
                    <h4>📊 同步进度</h4>
                    <p><strong>当前进度:</strong> ${percentage}% (${current}/${total})</p>
                    ${message ? `<p><strong>状态:</strong> ${message}</p>` : ''}
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="progress-text">${percentage}% 完成</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // 设置按钮状态
        function setSyncButtonState(disabled) {
            const buttons = document.querySelectorAll('#stockManagementCard button[onclick*="sync"]');
            buttons.forEach(button => {
                button.disabled = disabled;
                if (disabled) {
                    button.classList.add('loading');
                    button.style.opacity = '0.7';
                } else {
                    button.classList.remove('loading');
                    button.style.opacity = '1';
                }
            });
        }

        // 股票列表同步
        async function syncStockList() {
            if (syncInProgress) {
                alert('当前有同步任务正在进行，请等待完成后再试');
                return;
            }

            const riskMessage = `⚠️ 风险提示

同步股票列表将执行以下操作：
• 更新所有股票的基本信息（代码、名称）
• 同步更新市值、市盈率、市净率等财务数据
• 此操作可能需要几分钟时间
• 现有数据将被完整覆盖

是否继续同步？`;
            
            if (!confirm(riskMessage)) {
                return;
            }
            
            syncInProgress = true;
            currentSyncType = 'stock_list';
            setSyncButtonState(true);
            
            showProgress('syncResult', 0, 100, '正在初始化...');
            
            try {
                // 先获取登录状态
                const authCheck = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!authCheck.ok) {
                    showError('syncResult', '请先登录系统后再进行数据同步');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/stocks/sync/list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    showSuccess('syncResult', `✅ 股票列表同步成功！\n共同步 ${result.data.synced_count} 只股票\n包含完整财务数据`);
                } else if (result.code === 401) {
                    showError('syncResult', '登录已过期，请重新登录后再试');
                } else {
                    showError('syncResult', result.message || '同步失败，请稍后重试');
                }
            } catch (error) {
                console.error('同步错误:', error);
                showError('syncResult', `同步失败: ${error.message || '网络连接异常，请检查网络后重试'}`);
            } finally {
                syncInProgress = false;
                currentSyncType = null;
                setSyncButtonState(false);
            }
        }
        
        // 历史数据同步
        async function syncStockHistory() {
            if (syncInProgress) {
                showCenterNotification('warning', '提示', '当前有同步任务正在进行，请等待完成后再试');
                return;
            }

            const riskMessage = `⚠️ 风险提示

同步历史数据将执行以下操作：
• 获取最近365天的完整股票历史数据
• 数据量较大，可能需要较长时间（30-60分钟）
• 会覆盖现有数据，请谨慎操作
• 建议在网络稳定时执行

是否继续同步？`;
            
            if (!confirm(riskMessage)) {
                return;
            }
            
            syncInProgress = true;
            currentSyncType = 'history';
            setSyncButtonState(true);
            
            showCenterNotification('info', '数据同步', '正在准备数据...', true, 0, 100, '正在初始化');
            
            try {
                // 先获取登录状态
                const authCheck = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!authCheck.ok) {
                    showCenterNotification('error', '登录失败', '请先登录系统后再进行数据同步');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/stocks/sync/history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        days: 365,
                        batch_size: 15,
                        delay: 1
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const total = result.data.total || 0;
                    const success = result.data.success || 0;
                    const failed = result.data.failed || 0;
                    
                    showCenterNotification('success', '同步完成', 
                        `✅ 历史数据同步完成！\n总计: ${total}只股票\n成功: ${success}只\n失败: ${failed}只`);
                } else if (result.code === 401) {
                    showCenterNotification('error', '登录过期', '登录已过期，请重新登录后再试');
                } else {
                    showCenterNotification('error', '同步失败', result.message || '同步失败，请稍后重试');
                }
            } catch (error) {
                console.error('同步错误:', error);
                showCenterNotification('error', '网络错误', `同步失败: ${error.message || '网络连接异常，请检查网络后重试'}`);
            } finally {
                syncInProgress = false;
                currentSyncType = null;
                setSyncButtonState(false);
            }
        }
        
        // 最新数据同步
        async function syncStockLatest() {
            if (syncInProgress) {
                showCenterNotification('warning', '提示', '当前有同步任务正在进行，请等待完成后再试');
                return;
            }

            const riskMessage = `⚠️ 风险提示

同步最新数据将执行以下操作：
• 增量更新最近30天的股票数据
• 只获取缺失的最新价格数据
• 速度较快，通常几分钟完成
• 仅更新价格数据，不影响股票基本信息

是否继续同步？`;
            
            if (!confirm(riskMessage)) {
                return;
            }
            
            syncInProgress = true;
            currentSyncType = 'latest';
            setSyncButtonState(true);
            
            // 立即显示中央进度提示
            showCenterNotification('info', '数据同步', '正在检查数据...', true, 0, 100, '正在初始化');
            
            try {
                // 先获取登录状态
                const authCheck = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!authCheck.ok) {
                    showCenterNotification('error', '登录失败', '请先登录系统后再进行数据同步');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/stocks/sync/latest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        days: 30,
                        batch_size: 20,
                        delay: 2
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const total = result.data.total || 0;
                    const success = result.data.success || 0;
                    const failed = result.data.failed || 0;
                    
                    showCenterNotification('success', '同步完成', 
                        `✅ 最新数据同步完成！\n总计: ${total}只股票\n成功: ${success}只\n失败: ${failed}只`);
                } else if (result.code === 401) {
                    showCenterNotification('error', '登录过期', '登录已过期，请重新登录后再试');
                } else {
                    showCenterNotification('error', '同步失败', result.message || '同步失败，请稍后重试');
                }
            } catch (error) {
                console.error('同步错误:', error);
                showCenterNotification('error', '网络错误', `同步失败: ${error.message || '网络连接异常，请检查网络后重试'}`);
            } finally {
                syncInProgress = false;
                currentSyncType = null;
                setSyncButtonState(false);
            }
        }

        // 其他功能函数（简化版本）
        async function analyzeStock() {
            showCenterNotification('warning', '功能不可用', '此功能在调试版本中不可用');
        }
        
        async function runBacktest() {
            showCenterNotification('warning', '功能不可用', '此功能在调试版本中不可用');
        }
        
        async function generateReport() {
            showCenterNotification('warning', '功能不可用', '此功能在调试版本中不可用');
        }
        // 中央提示功能
        function showCenterNotification(type, title, message, showProgressBar = false, current = 0, total = 0, progressText = '') {
            // 移除旧的提示
            const oldOverlay = document.querySelector('.notification-overlay');
            if (oldOverlay) {
                oldOverlay.remove();
            }

            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.className = 'notification-overlay';
            
            // 创建中央提示框
            const notification = document.createElement('div');
            notification.className = 'notification-center';
            
            let content = '';
            let icon = '';
            let color = '';
            
            switch(type) {
                case 'success':
                    icon = '✅';
                    color = '#28a745';
                    break;
                case 'error':
                    icon = '❌';
                    color = '#dc3545';
                    break;
                case 'warning':
                    icon = '⚠️';
                    color = '#ffc107';
                    break;
                default:
                    icon = '⏳';
                    color = '#007bff';
            }

            content = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">${icon}</div>
                <h3 style="color: ${color}; margin-bottom: 1rem; font-size: 1.2rem;">${title}</h3>
                <div style="margin-bottom: 1rem; white-space: pre-line; line-height: 1.6;">${message}</div>
            `;

            if (showProgressBar) {
                const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
                content += `
                    <div style="margin: 1rem 0;">
                        <div style="width: 100%; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; border-radius: 4px;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                            ${progressText} (${percentage}%)
                        </div>
                    </div>
                `;
            }

            content += `
                <button onclick="this.closest('.notification-overlay').remove()" 
                        style="background: ${color}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-top: 1rem;">
                    关闭
                </button>
            `;

            notification.innerHTML = content;
            overlay.appendChild(notification);
            document.body.appendChild(overlay);

            // 点击遮罩关闭
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });

            return overlay;
        }

        // 修改原有的提示函数
        function showProgress(elementId, current, total, text) {
            const notification = showCenterNotification('info', '数据同步中', '正在同步股票数据，请稍候...', true, current, total, text);
            return notification;
        }

        function showSuccess(elementId, message) {
            showCenterNotification('success', '同步成功', message);
        }

        function showError(elementId, message) {
            showCenterNotification('error', '同步失败', message);
        }

        // 其他功能函数（简化版本）
        async function analyzeStock() {
            showCenterNotification('warning', '功能不可用', '此功能在调试版本中不可用');
        }
        
        async function runBacktest() {
            showCenterNotification('warning', '功能不可用', '此功能在调试版本中不可用');
        }
        
        async function generateReport() {
            showCenterNotification('warning', '功能不可用', '此功能在调试版本中不可用');
        }
    </script>
</body>
</html>