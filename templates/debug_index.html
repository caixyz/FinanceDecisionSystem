<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èå†³ç­–ç³»ç»Ÿ - è°ƒè¯•ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            background-color: #f8f9fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .header p {
            text-align: center;
            opacity: 0.9;
        }

        .main-content {
            padding: 2rem 0;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.loading {
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.8s linear infinite;
        }

        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }

        .result-container {
            margin-top: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .success {
            color: #155724;
            background-color: #d4edda;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .metric {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            text-align: center;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .sync-status {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
        }

        /* ä¸­å¤®æç¤ºæ ·å¼ */
        .notification-center {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }

        .sync-status h4 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .sync-status p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸ¦ é‡‘èå†³ç­–ç³»ç»Ÿ</h1>
            <p>åŸºäº AKShare çš„æ™ºèƒ½è‚¡ç¥¨åˆ†æå¹³å°</p>
        </div>
    </div>

    <div class="container main-content">
        <!-- è‚¡ç¥¨åˆ†æ -->
        <div class="card">
            <h2>ğŸ“ˆ è‚¡ç¥¨æŠ€æœ¯åˆ†æ</h2>
            <div class="form-group">
                <label for="stockSymbol">è‚¡ç¥¨ä»£ç :</label>
                <input type="text" id="stockSymbol" placeholder="ä¾‹å¦‚: 000001" />
            </div>
            <div class="form-group">
                <label for="analysisDays">åˆ†æå¤©æ•°:</label>
                <select id="analysisDays">
                    <option value="30">30å¤©</option>
                    <option value="60">60å¤©</option>
                    <option value="90" selected>90å¤©</option>
                    <option value="180">180å¤©</option>
                    <option value="252">ä¸€å¹´</option>
                </select>
            </div>
            <button class="btn" onclick="analyzeStock()">å¼€å§‹åˆ†æ</button>
            <div id="analysisResult" class="result-container"></div>
        </div>

        <!-- ç­–ç•¥å›æµ‹ -->
        <div class="card">
            <h2>ğŸ”„ ç­–ç•¥å›æµ‹</h2>
            <div class="form-group">
                <label for="backtestSymbol">è‚¡ç¥¨ä»£ç :</label>
                <input type="text" id="backtestSymbol" placeholder="ä¾‹å¦‚: 000001" />
            </div>
            <div class="form-group">
                <label for="strategy">äº¤æ˜“ç­–ç•¥:</label>
                <select id="strategy">
                    <option value="MAç­–ç•¥">MAç­–ç•¥</option>
                    <option value="RSIç­–ç•¥">RSIç­–ç•¥</option>
                    <option value="MACDç­–ç•¥">MACDç­–ç•¥</option>
                    <option value="å¸ƒæ—å¸¦ç­–ç•¥">å¸ƒæ—å¸¦ç­–ç•¥</option>
                    <option value="ç»¼åˆç­–ç•¥">ç»¼åˆç­–ç•¥</option>
                </select>
            </div>
            <button class="btn" onclick="runBacktest()">å¼€å§‹å›æµ‹</button>
            <div id="backtestResult" class="result-container"></div>
        </div>

        <!-- ç”ŸæˆæŠ¥å‘Š -->
        <div class="card">
            <h2>ğŸ“Š ç”Ÿæˆåˆ†ææŠ¥å‘Š</h2>
            <div class="form-group">
                <label for="reportSymbol">è‚¡ç¥¨ä»£ç :</label>
                <input type="text" id="reportSymbol" placeholder="ä¾‹å¦‚: 000001" />
            </div>
            <button class="btn" onclick="generateReport()">ç”ŸæˆæŠ¥å‘Š</button>
            <div id="reportResult" class="result-container"></div>
        </div>

        <!-- è‚¡ç¥¨æ•°æ®ç®¡ç† -->
        <div class="card" id="stockManagementCard">
            <h2>ğŸ’¾ è‚¡ç¥¨æ•°æ®ç®¡ç†</h2>
            <div class="form-group">
                <label for="searchKeyword">æœç´¢è‚¡ç¥¨:</label>
                <input type="text" id="searchKeyword" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°" />
                <button class="btn" onclick="searchStocks()" style="margin-top: 10px;">æœç´¢</button>
            </div>
            <div id="searchResult" class="result-container"></div>
            
            <div style="margin-top: 2rem;">
                <h3>æ•°æ®åŒæ­¥</h3>
                <button class="btn" onclick="syncStockList()" style="margin-right: 10px;">ğŸ”„ åŒæ­¥è‚¡ç¥¨åˆ—è¡¨</button>
                <button class="btn" onclick="syncStockHistory()" style="margin-right: 10px;">ğŸ“š åŒæ­¥å†å²æ•°æ®</button>
                <button class="btn" onclick="syncStockLatest()">âš¡ åŒæ­¥æœ€æ–°æ•°æ®</button>
            </div>
            <div id="syncResult" class="result-container"></div>
        </div>
        
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="card">
            <h2>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h2>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥è‚¡ç¥¨æ•°æ®ç®¡ç†å¡ç‰‡æ˜¯å¦å­˜åœ¨
            const stockManagementCard = document.getElementById('stockManagementCard');
            const debugInfo = document.getElementById('debugInfo');
            
            if (stockManagementCard) {
                debugInfo.innerHTML = '<div style="color: green;">âœ… è‚¡ç¥¨æ•°æ®ç®¡ç†åŒºåŸŸå·²æ‰¾åˆ°</div>';
            } else {
                debugInfo.innerHTML = '<div style="color: red;">âŒ æœªæ‰¾åˆ°è‚¡ç¥¨æ•°æ®ç®¡ç†åŒºåŸŸ</div>';
            }
            
            // æ˜¾ç¤ºé¡µé¢ä¸Šæ‰€æœ‰å¡ç‰‡çš„æ•°é‡
            const cards = document.querySelectorAll('.card');
            debugInfo.innerHTML += `<div>ğŸ“Š é¡µé¢ä¸Šå…±æœ‰ ${cards.length} ä¸ªåŠŸèƒ½å¡ç‰‡</div>`;
            
            // åˆ—å‡ºæ‰€æœ‰å¡ç‰‡çš„æ ‡é¢˜
            cards.forEach((card, index) => {
                const title = card.querySelector('h2');
                if (title) {
                    debugInfo.innerHTML += `<div>ğŸ“‹ å¡ç‰‡ ${index + 1}: ${title.textContent}</div>`;
                }
            });
        });

        // API åŸºç¡€URL
        const API_BASE = '/api';

        // å·¥å…·å‡½æ•°
        function showLoading(containerId) {
            document.getElementById(containerId).innerHTML = '<div class="loading">â³ å¤„ç†ä¸­...</div>';
        }

        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="error">âŒ ${message}</div>`;
        }

        function showSuccess(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="success">âœ… ${message}</div>`;
        }

        // è‚¡ç¥¨æœç´¢åŠŸèƒ½
        async function searchStocks() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            
            if (!keyword) {
                showError('searchResult', 'è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            showLoading('searchResult');
            
            try {
                // å…ˆè·å–å®Œæ•´çš„æœç´¢ç»“æœæ€»æ•°
                const countResponse = await fetch(`${API_BASE}/stocks/list?keyword=${encodeURIComponent(keyword)}&limit=10000`);
                const countResult = await countResponse.json();
                
                if (countResult.code === 200) {
                    // å­˜å‚¨å®Œæ•´çš„æœç´¢ç»“æœç”¨äºæ˜¾ç¤ºæ€»æ•°
                    window.searchResults = {
                        stocks: countResult.data.stocks,
                        total_count: countResult.data.stocks.length
                    };
                    displaySearchResults(countResult.data.stocks.slice(0, 20)); // åªæ˜¾ç¤ºå‰20æ¡
                } else {
                    showError('searchResult', countResult.message);
                }
            } catch (error) {
                showError('searchResult', `æœç´¢å¤±è´¥: ${error.message}`);
            }
        }
        
        function displaySearchResults(stocks) {
            const container = document.getElementById('searchResult');

            if (stocks.length === 0) {
                container.innerHTML = '<div class="error">æœªæ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨</div>';
                return;
            }

            // è·å–å®Œæ•´çš„æœç´¢ç»“æœæ€»æ•°ï¼ˆä¸ä»…ä»…æ˜¯å½“å‰é¡µï¼‰
            let totalCount = stocks.length;
            if (window.searchResults && window.searchResults.total_count) {
                totalCount = window.searchResults.total_count;
            }
            
            let html = '<h3 style="margin-bottom: 1rem;">æœç´¢ç»“æœ</h3>' +
                '<div class="grid">';
            stocks.forEach(stock => {
                html += `
                    <div class="metric" style="text-align: left;">
                        <div style="font-weight: bold; font-size: 1.2rem;">${stock.symbol}</div>
                        <div style="font-size: 1rem; margin: 5px 0;">${stock.name}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            // æ·»åŠ ç»“æœæ€»æ•°
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem; background-color: #f8f9fa; border-radius: 8px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                        ç»“æœæ€»æ•°: ${totalCount}
                    </div>
                    <div style="color: #666; font-size: 0.9rem;">
                        æ˜¾ç¤º ${stocks.length} æ¡è®°å½•
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // æ•°æ®åŒæ­¥åŠŸèƒ½ - å¸¦åé‡å¤ç‚¹å‡»å’Œè¿›åº¦æ¡
        let syncInProgress = false;
        let currentSyncType = null;

        // è¿›åº¦æ¡å·¥å…·å‡½æ•°
        function showProgress(containerId, current, total, message = '') {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            const container = document.getElementById(containerId);
            
            let html = `
                <div class="sync-status">
                    <h4>ğŸ“Š åŒæ­¥è¿›åº¦</h4>
                    <p><strong>å½“å‰è¿›åº¦:</strong> ${percentage}% (${current}/${total})</p>
                    ${message ? `<p><strong>çŠ¶æ€:</strong> ${message}</p>` : ''}
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="progress-text">${percentage}% å®Œæˆ</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // è®¾ç½®æŒ‰é’®çŠ¶æ€
        function setSyncButtonState(disabled) {
            const buttons = document.querySelectorAll('#stockManagementCard button[onclick*="sync"]');
            buttons.forEach(button => {
                button.disabled = disabled;
                if (disabled) {
                    button.classList.add('loading');
                    button.style.opacity = '0.7';
                } else {
                    button.classList.remove('loading');
                    button.style.opacity = '1';
                }
            });
        }

        // è‚¡ç¥¨åˆ—è¡¨åŒæ­¥
        async function syncStockList() {
            if (syncInProgress) {
                alert('å½“å‰æœ‰åŒæ­¥ä»»åŠ¡æ­£åœ¨è¿›è¡Œï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•');
                return;
            }

            const riskMessage = `âš ï¸ é£é™©æç¤º

åŒæ­¥è‚¡ç¥¨åˆ—è¡¨å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
â€¢ æ›´æ–°æ‰€æœ‰è‚¡ç¥¨çš„åŸºæœ¬ä¿¡æ¯ï¼ˆä»£ç ã€åç§°ï¼‰
â€¢ åŒæ­¥æ›´æ–°å¸‚å€¼ã€å¸‚ç›ˆç‡ã€å¸‚å‡€ç‡ç­‰è´¢åŠ¡æ•°æ®
â€¢ æ­¤æ“ä½œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´
â€¢ ç°æœ‰æ•°æ®å°†è¢«å®Œæ•´è¦†ç›–

æ˜¯å¦ç»§ç»­åŒæ­¥ï¼Ÿ`;
            
            if (!confirm(riskMessage)) {
                return;
            }
            
            syncInProgress = true;
            currentSyncType = 'stock_list';
            setSyncButtonState(true);
            
            showProgress('syncResult', 0, 100, 'æ­£åœ¨åˆå§‹åŒ–...');
            
            try {
                // å…ˆè·å–ç™»å½•çŠ¶æ€
                const authCheck = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!authCheck.ok) {
                    showError('syncResult', 'è¯·å…ˆç™»å½•ç³»ç»Ÿåå†è¿›è¡Œæ•°æ®åŒæ­¥');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/stocks/sync/list`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    showSuccess('syncResult', `âœ… è‚¡ç¥¨åˆ—è¡¨åŒæ­¥æˆåŠŸï¼\nå…±åŒæ­¥ ${result.data.synced_count} åªè‚¡ç¥¨\nåŒ…å«å®Œæ•´è´¢åŠ¡æ•°æ®`);
                } else if (result.code === 401) {
                    showError('syncResult', 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•');
                } else {
                    showError('syncResult', result.message || 'åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('åŒæ­¥é”™è¯¯:', error);
                showError('syncResult', `åŒæ­¥å¤±è´¥: ${error.message || 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'}`);
            } finally {
                syncInProgress = false;
                currentSyncType = null;
                setSyncButtonState(false);
            }
        }
        
        // å†å²æ•°æ®åŒæ­¥
        async function syncStockHistory() {
            if (syncInProgress) {
                showCenterNotification('warning', 'æç¤º', 'å½“å‰æœ‰åŒæ­¥ä»»åŠ¡æ­£åœ¨è¿›è¡Œï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•');
                return;
            }

            const riskMessage = `âš ï¸ é£é™©æç¤º

åŒæ­¥å†å²æ•°æ®å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
â€¢ è·å–æœ€è¿‘365å¤©çš„å®Œæ•´è‚¡ç¥¨å†å²æ•°æ®
â€¢ æ•°æ®é‡è¾ƒå¤§ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆ30-60åˆ†é’Ÿï¼‰
â€¢ ä¼šè¦†ç›–ç°æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ
â€¢ å»ºè®®åœ¨ç½‘ç»œç¨³å®šæ—¶æ‰§è¡Œ

æ˜¯å¦ç»§ç»­åŒæ­¥ï¼Ÿ`;
            
            if (!confirm(riskMessage)) {
                return;
            }
            
            syncInProgress = true;
            currentSyncType = 'history';
            setSyncButtonState(true);
            
            showCenterNotification('info', 'æ•°æ®åŒæ­¥', 'æ­£åœ¨å‡†å¤‡æ•°æ®...', true, 0, 100, 'æ­£åœ¨åˆå§‹åŒ–');
            
            try {
                // å…ˆè·å–ç™»å½•çŠ¶æ€
                const authCheck = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!authCheck.ok) {
                    showCenterNotification('error', 'ç™»å½•å¤±è´¥', 'è¯·å…ˆç™»å½•ç³»ç»Ÿåå†è¿›è¡Œæ•°æ®åŒæ­¥');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/stocks/sync/history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        days: 365,
                        batch_size: 15,
                        delay: 1
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const total = result.data.total || 0;
                    const success = result.data.success || 0;
                    const failed = result.data.failed || 0;
                    
                    showCenterNotification('success', 'åŒæ­¥å®Œæˆ', 
                        `âœ… å†å²æ•°æ®åŒæ­¥å®Œæˆï¼\næ€»è®¡: ${total}åªè‚¡ç¥¨\næˆåŠŸ: ${success}åª\nå¤±è´¥: ${failed}åª`);
                } else if (result.code === 401) {
                    showCenterNotification('error', 'ç™»å½•è¿‡æœŸ', 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•');
                } else {
                    showCenterNotification('error', 'åŒæ­¥å¤±è´¥', result.message || 'åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('åŒæ­¥é”™è¯¯:', error);
                showCenterNotification('error', 'ç½‘ç»œé”™è¯¯', `åŒæ­¥å¤±è´¥: ${error.message || 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'}`);
            } finally {
                syncInProgress = false;
                currentSyncType = null;
                setSyncButtonState(false);
            }
        }
        
        // æœ€æ–°æ•°æ®åŒæ­¥
        async function syncStockLatest() {
            if (syncInProgress) {
                showCenterNotification('warning', 'æç¤º', 'å½“å‰æœ‰åŒæ­¥ä»»åŠ¡æ­£åœ¨è¿›è¡Œï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•');
                return;
            }

            const riskMessage = `âš ï¸ é£é™©æç¤º

åŒæ­¥æœ€æ–°æ•°æ®å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
â€¢ å¢é‡æ›´æ–°æœ€è¿‘30å¤©çš„è‚¡ç¥¨æ•°æ®
â€¢ åªè·å–ç¼ºå¤±çš„æœ€æ–°ä»·æ ¼æ•°æ®
â€¢ é€Ÿåº¦è¾ƒå¿«ï¼Œé€šå¸¸å‡ åˆ†é’Ÿå®Œæˆ
â€¢ ä»…æ›´æ–°ä»·æ ¼æ•°æ®ï¼Œä¸å½±å“è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯

æ˜¯å¦ç»§ç»­åŒæ­¥ï¼Ÿ`;
            
            if (!confirm(riskMessage)) {
                return;
            }
            
            syncInProgress = true;
            currentSyncType = 'latest';
            setSyncButtonState(true);
            
            // ç«‹å³æ˜¾ç¤ºä¸­å¤®è¿›åº¦æç¤º
            showCenterNotification('info', 'æ•°æ®åŒæ­¥', 'æ­£åœ¨æ£€æŸ¥æ•°æ®...', true, 0, 100, 'æ­£åœ¨åˆå§‹åŒ–');
            
            try {
                // å…ˆè·å–ç™»å½•çŠ¶æ€
                const authCheck = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (!authCheck.ok) {
                    showCenterNotification('error', 'ç™»å½•å¤±è´¥', 'è¯·å…ˆç™»å½•ç³»ç»Ÿåå†è¿›è¡Œæ•°æ®åŒæ­¥');
                    return;
                }
                
                const response = await fetch(`${API_BASE}/stocks/sync/latest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        days: 30,
                        batch_size: 20,
                        delay: 2
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const total = result.data.total || 0;
                    const success = result.data.success || 0;
                    const failed = result.data.failed || 0;
                    
                    showCenterNotification('success', 'åŒæ­¥å®Œæˆ', 
                        `âœ… æœ€æ–°æ•°æ®åŒæ­¥å®Œæˆï¼\næ€»è®¡: ${total}åªè‚¡ç¥¨\næˆåŠŸ: ${success}åª\nå¤±è´¥: ${failed}åª`);
                } else if (result.code === 401) {
                    showCenterNotification('error', 'ç™»å½•è¿‡æœŸ', 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•');
                } else {
                    showCenterNotification('error', 'åŒæ­¥å¤±è´¥', result.message || 'åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            } catch (error) {
                console.error('åŒæ­¥é”™è¯¯:', error);
                showCenterNotification('error', 'ç½‘ç»œé”™è¯¯', `åŒæ­¥å¤±è´¥: ${error.message || 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'}`);
            } finally {
                syncInProgress = false;
                currentSyncType = null;
                setSyncButtonState(false);
            }
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        async function analyzeStock() {
            showCenterNotification('warning', 'åŠŸèƒ½ä¸å¯ç”¨', 'æ­¤åŠŸèƒ½åœ¨è°ƒè¯•ç‰ˆæœ¬ä¸­ä¸å¯ç”¨');
        }
        
        async function runBacktest() {
            showCenterNotification('warning', 'åŠŸèƒ½ä¸å¯ç”¨', 'æ­¤åŠŸèƒ½åœ¨è°ƒè¯•ç‰ˆæœ¬ä¸­ä¸å¯ç”¨');
        }
        
        async function generateReport() {
            showCenterNotification('warning', 'åŠŸèƒ½ä¸å¯ç”¨', 'æ­¤åŠŸèƒ½åœ¨è°ƒè¯•ç‰ˆæœ¬ä¸­ä¸å¯ç”¨');
        }
        // ä¸­å¤®æç¤ºåŠŸèƒ½
        function showCenterNotification(type, title, message, showProgressBar = false, current = 0, total = 0, progressText = '') {
            // ç§»é™¤æ—§çš„æç¤º
            const oldOverlay = document.querySelector('.notification-overlay');
            if (oldOverlay) {
                oldOverlay.remove();
            }

            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'notification-overlay';
            
            // åˆ›å»ºä¸­å¤®æç¤ºæ¡†
            const notification = document.createElement('div');
            notification.className = 'notification-center';
            
            let content = '';
            let icon = '';
            let color = '';
            
            switch(type) {
                case 'success':
                    icon = 'âœ…';
                    color = '#28a745';
                    break;
                case 'error':
                    icon = 'âŒ';
                    color = '#dc3545';
                    break;
                case 'warning':
                    icon = 'âš ï¸';
                    color = '#ffc107';
                    break;
                default:
                    icon = 'â³';
                    color = '#007bff';
            }

            content = `
                <div style="font-size: 2rem; margin-bottom: 1rem;">${icon}</div>
                <h3 style="color: ${color}; margin-bottom: 1rem; font-size: 1.2rem;">${title}</h3>
                <div style="margin-bottom: 1rem; white-space: pre-line; line-height: 1.6;">${message}</div>
            `;

            if (showProgressBar) {
                const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
                content += `
                    <div style="margin: 1rem 0;">
                        <div style="width: 100%; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; border-radius: 4px;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                            ${progressText} (${percentage}%)
                        </div>
                    </div>
                `;
            }

            content += `
                <button onclick="this.closest('.notification-overlay').remove()" 
                        style="background: ${color}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-top: 1rem;">
                    å…³é—­
                </button>
            `;

            notification.innerHTML = content;
            overlay.appendChild(notification);
            document.body.appendChild(overlay);

            // ç‚¹å‡»é®ç½©å…³é—­
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });

            return overlay;
        }

        // ä¿®æ”¹åŸæœ‰çš„æç¤ºå‡½æ•°
        function showProgress(elementId, current, total, text) {
            const notification = showCenterNotification('info', 'æ•°æ®åŒæ­¥ä¸­', 'æ­£åœ¨åŒæ­¥è‚¡ç¥¨æ•°æ®ï¼Œè¯·ç¨å€™...', true, current, total, text);
            return notification;
        }

        function showSuccess(elementId, message) {
            showCenterNotification('success', 'åŒæ­¥æˆåŠŸ', message);
        }

        function showError(elementId, message) {
            showCenterNotification('error', 'åŒæ­¥å¤±è´¥', message);
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        async function analyzeStock() {
            showCenterNotification('warning', 'åŠŸèƒ½ä¸å¯ç”¨', 'æ­¤åŠŸèƒ½åœ¨è°ƒè¯•ç‰ˆæœ¬ä¸­ä¸å¯ç”¨');
        }
        
        async function runBacktest() {
            showCenterNotification('warning', 'åŠŸèƒ½ä¸å¯ç”¨', 'æ­¤åŠŸèƒ½åœ¨è°ƒè¯•ç‰ˆæœ¬ä¸­ä¸å¯ç”¨');
        }
        
        async function generateReport() {
            showCenterNotification('warning', 'åŠŸèƒ½ä¸å¯ç”¨', 'æ­¤åŠŸèƒ½åœ¨è°ƒè¯•ç‰ˆæœ¬ä¸­ä¸å¯ç”¨');
        }
    </script>
</body>
</html>